---

- name: ca root dir
  ansible.builtin.file:
    path: "{{ ca_root_dir }}"
    state: directory

- name: ca root 'private' dir
  ansible.builtin.file:
    path: "{{ ca_root_dir }}/private"
    state: directory

- name: CA Root Private Key
  community.crypto.openssl_privatekey:
    path: "{{ ca_root_dir }}/private/root-ca.key.pem"
    passphrase: "{{ ca_root_passphrase }}"
    cipher: aes256
  register: ca_root_key

- name: CA Root Cert (see if exists)
  stat:
    path: "{{ ca_root_dir }}/root-ca.crt"
  register: ca_root_cert_stat

- name: CA Root CSR
  block:

    - name: CA Root CSR
      community.crypto.openssl_csr:
        path: "{{ ca_root_dir }}/root-ca.csr"
        common_name: "my-root-ca"
        privatekey_path: "{{ ca_root_key.filename }}"
        privatekey_passphrase: "{{ ca_root_passphrase }}"
      register: ca_root_csr

    - name: CA Root sign CSR
      community.crypto.x509_certificate:
        path: "{{ ca_root_dir }}/root-ca.crt"
        csr_path: "{{ ca_root_csr.filename }}"
        provider: selfsigned
        privatekey_path: "{{ ca_root_key.filename }}"
        privatekey_passphrase: "{{ ca_root_passphrase }}"
      register: ca_root_crt

  when: not ca_root_cert_stat.stat.exists

  always:
     - name: Clean up CA Root CSR
       file:
         path: "{{ ca_root_dir }}/root-ca.csr"
         state: absent
